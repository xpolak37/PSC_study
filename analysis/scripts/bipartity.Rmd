---
title: "PSC signiture - bipartity graphs"
output: html_notebook
---

# Data Import

Importing ASV, taxa and metadata tables for both czech and norway
samples.

## IKEM data

```{r}
source("custom_functions.R")
library(jsonlite)
```

```{r}
asv_tab_ikem <- as.data.frame(fread("data/ikem/asv_table_ikem.csv",check.names = FALSE))
taxa_tab_ikem <- as.data.frame(fread("data/ikem/taxa_table_ikem.csv",check.names = FALSE))
metadata_ikem <- as.data.frame(fread("data/ikem/metadata_ikem.csv",check.names = FALSE))
```

## Norway data

```{r}
asv_tab_norway <- as.data.frame(fread("data/norway/asv_table_norway.csv",check.names = FALSE))
taxa_tab_norway <- as.data.frame(fread("data/norway/taxa_table_norway.csv",check.names = FALSE))
metadata_norway <- as.data.frame(fread("data/norway/metadata_norway.csv",check.names = FALSE))
```

## Merging

Merging two countries to create whole dataset

```{r}
asv_tab <- merge(asv_tab_ikem,asv_tab_norway,by="SeqID",all=TRUE)
taxa_tab <- merging_taxa_tables(taxa_tab_ikem,taxa_tab_norway)
```

Merging two countries based on the different matrices - Ileum, Colon.

### Terminal ileum

```{r}
ileum_data <- merging_data(asv_tab_1=asv_tab_ikem,
                           asv_tab_2=asv_tab_norway,
                           taxa_tab_1=taxa_tab_ikem,
                           taxa_tab_2=taxa_tab_norway,
                           metadata_1=metadata_ikem,
                           metadata_2=metadata_norway,
                           segment="TI",Q="clinical")

ileum_asv_tab <- ileum_data[[1]]
ileum_taxa_tab <- ileum_data[[2]]
ileum_metadata <- ileum_data[[3]]
```

### Colon

```{r}
colon_data <- merging_data(asv_tab_1=asv_tab_ikem,
                           asv_tab_2=asv_tab_norway,
                           taxa_tab_1=taxa_tab_ikem,
                           taxa_tab_2=taxa_tab_norway,
                           metadata_1=metadata_ikem,
                           metadata_2=metadata_norway,
                           segment="colon",Q="clinical")

colon_asv_tab <- colon_data[[1]]
colon_taxa_tab <- colon_data[[2]]
colon_metadata <- colon_data[[3]]
```


## Aggregating metadata

```{r}
metadata_final <- read.xlsx("pacienti/final_metadata/metadata_final_clinical.xlsx")

metadata_final$kalprotektin[metadata_final$Group=="healthy"] <- NA
metadata_final$INR[metadata_final$Group=="healthy"] <- NA
metadata_ileum <- metadata_final %>% subset(Matrix=="TI") %>% as.data.frame()
metadata_colon <- metadata_final %>% subset(Matrix!="TI") %>% as.data.frame()
```

# Network construction

## Ileum

### Raw data

```{r}
genus_data <- aggregate_taxa(ileum_asv_tab,
                             ileum_taxa_tab,
                             taxonomic_level = "Genus")

ileum_genus_tab <- genus_data[[1]]
ileum_genus_taxa_tab <- genus_data[[2]]

ileum_genus_tab_groups <- aggregate_samples(ileum_genus_tab,
                                            ileum_genus_taxa_tab,
                                            metadata_ileum,
                                            variable = "Group")

metadata_ileum_groups <- data.frame(SampleID=colnames(ileum_genus_tab_groups)[-1],
                                    some_variable="NA")

ps <- construct_phyloseq(ileum_genus_tab_groups,
                         ileum_genus_taxa_tab,
                         metadata_ileum_groups)

mcg <- build_mc_graph(ps_object = ps)

adj <- adjacencyMatrix(graph_object = mcg)
adj <- adj$x$graph
adj <- fromJSON(adj)
nodes <- adj$nodes
edges <- adj$links
```

```{r}
adj <- adjacencyMatrix(graph_object = mcg)
adj <- adj$x$graph
adj <- fromJSON(adj)
nodes <- adj$nodes
edges <- adj$links

# add in how many samples it was observed
nodes$observed_in_num_samples <- NA 
for (i in 5:nrow(nodes)){
  name <- nodes$node[i]
  count <- sum(ileum_genus_tab[ileum_genus_tab$SeqID==name,2:ncol(ileum_genus_tab)]>0)
  nodes[i,"observed_in_num_samples"] <- count
}

write.csv(nodes,"results/network_snowflake/ileum/raw/nodes.csv")
write.csv(edges,"results/network_snowflake/ileum/raw/edges.csv")
```

### Filtered data

```{r}
filt_data <- filtering_steps(ileum_genus_tab,
                             ileum_genus_taxa_tab,
                             metadata_ileum,
                             seq_depth_threshold = 10000)

filt_ileum_genus_tab <- filt_data[[1]]
filt_ileum_genus_taxa <- filt_data[[2]]
filt_ileum_metadata <- filt_data[[3]]
```

```{r}
nodes$is_in_filtered <- NA 
for (i in 5:nrow(nodes)){
  name <- nodes$node[i]
  bool_var <- name %in% filt_ileum_genus_tab$SeqID
  nodes[i,"is_in_filtered"] <- bool_var
}

write.csv(nodes,"results/network_snowflake/ileum/filtered/nodes.csv")
```

## Colon

### Raw data
```{r}
genus_data <- aggregate_taxa(colon_asv_tab,
                             colon_taxa_tab,
                             taxonomic_level = "Genus")
colon_genus_tab <- genus_data[[1]]
colon_genus_taxa_tab <- genus_data[[2]]

colon_genus_tab_groups <- aggregate_samples(colon_genus_tab,
                                            colon_genus_taxa_tab,
                                            metadata_colon,
                                            variable = "Group")

metadata_colon_groups <- data.frame(SampleID=colnames(colon_genus_tab_groups)[-1],
                                    some_variable="NA")

ps <- construct_phyloseq(colon_genus_tab_groups,
                         colon_genus_taxa_tab,
                         metadata_colon_groups)

mcg <- build_mc_graph(ps_object = ps)
```

```{r}
adj <- adjacencyMatrix(graph_object = mcg)
adj <- adj$x$graph
adj <- fromJSON(adj)
nodes <- adj$nodes
edges <- adj$links

write.csv(nodes,"results/network_snowflake/colon/raw/nodes.csv")
write.csv(edges,"results/network_snowflake/colon/raw/edges.csv")
```


```{r}
nodes$observed_in_num_samples <- NA 
for (i in 5:nrow(nodes)){
  name <- nodes$id[i]
  count <- sum(colon_genus_tab[colon_genus_tab$SeqID==name,2:ncol(colon_genus_tab)]>0)
  nodes[i,"observed_in_num_samples"] <- count
}

write.csv(nodes,"results/network_snowflake/colon/raw/nodes.csv")
```

### Filtered data

```{r}
filt_data <- filtering_steps(colon_genus_tab,
                             colon_genus_taxa_tab,
                             metadata_colon,
                             seq_depth_threshold = 10000)

filt_colon_genus_tab <- filt_data[[1]]
filt_colon_genus_taxa <- filt_data[[2]]
filt_colon_metadata <- filt_data[[3]]
```

```{r}
nodes$is_in_filtered <- NA 
for (i in 5:nrow(nodes)){
  name <- nodes$id[i]
  bool_var <- name %in% filt_colon_genus_tab$SeqID
  nodes[i,"is_in_filtered"] <- bool_var
}
write.csv(nodes,"results/network_snowflake/colon/filtered/nodes.csv")
write.csv(edges,"results/network_snowflake/colon/filtered/edges.csv")
```

# Session info

```{r}
sessionInfo()
```